define(function(){
	var setCookie=function(c_name,value,expiredays,domain){
		var exdate=new Date();
		exdate.setDate(exdate.getDate()+expiredays);
		document.cookie=c_name+ "=" +escape(value)+
		((expiredays==null) ? "" : (";expires="+exdate.toGMTString()) + ';path=/;'+(domain?' domain='+domain:''));
	};
	
	var getCookie=function(c_name){
		if (document.cookie.length>0){
			c_start=document.cookie.indexOf(c_name + "=");
			if (c_start!=-1){
				c_start=c_start + c_name.length+1;
				c_end=document.cookie.indexOf(";",c_start);
				if (c_end==-1){
					c_end=document.cookie.length;
				}
				
				return unescape(document.cookie.substring(c_start,c_end));
			} 
		}
		return "";
	}
	
	if((getCookie('__track')||'').length>12){
		setCookie('__track','',-1,'');
	}
	
	if(!getCookie('__track')){
		setCookie('__track',String(Math.random()).substring(2,14),365,'.eucita.com');
	}
	
	var GA = function(id){ 
		this.id=id;
		this.param = {};
	};
 
	GA.prototype.add = function(key,value){ 
		if ( value != null ) {
			this.param[key] = value;
		}
	};
 
	GA.prototype.getHashString = function(key){
		var uri = window.location.hash.toString();
		var re = new RegExp("" +key+ "=([^&?]*)", "ig");
		return ((uri.match(re))?decodeURIComponent((uri.match(re)[0].substr(key.length+1))):"");
	}
 
	GA.prototype.getQueryString = function(key){
		var uri = window.location.search.toString();
		var re = new RegExp("" +key+ "=([^&?]*)", "ig");
		return ((uri.match(re))?decodeURIComponent((uri.match(re)[0].substr(key.length+1))):"");
	}
 
	GA.prototype.send = function(){
		var img = new Image();
		img.src = "http://bc.eucita.com/beacon/"+this.id+"?"+this._collect_params();
	};
 
	GA.prototype._collect_params = function(){
		return encodeURIComponent(JSON.stringify(this.param));
		/*
		var s = [];
		var p = this.param;
		for( var k in p ) {
			s.push( k + '=' + encodeURIComponent(p[k]) );
		}
		return s.join('&');
		*/
	};
 
	GA.prototype.getDomain = function( _domain ){
		return (_domain||"").replace(/^.+\.(.+?\..+)$/,'$1');
	}
	 
	var addBeacon=function(id,args){
	 
		var ga = new GA(id);
		 //站内外监测cookie
		var _domain = ga.getDomain( document.domain );
		//当前唯一ID号，防止GIF被缓存
		ga.add('_',Math.random());
		//屏幕分辨率
		ga.add('sc', screen.availWidth + "*" + screen.availHeight );
		//当前页的reference
		ga.add('ref', document.referrer || "-1" );
		//当前页面的URI
		ga.add('uri', window.location.href.toString() );
		//访问域名
		ga.add('host', window.location.host.toString() );
		
		//跟踪参数
		ga.add('track', getCookie('__track'));
		
		//当前页面在Beacon系统中ID
		ga.add('domain', _domain);
		 
		for( var method in args){
			ga.add(method,args[method]);
		}
		ga.send();
	};
	 
	return addBeacon;
});